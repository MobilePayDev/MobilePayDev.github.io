"use strict";(self.webpackChunkmobile_pay_merchant_payments_documentation=self.webpackChunkmobile_pay_merchant_payments_documentation||[]).push([[8310],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>c});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var o=n.createContext({}),m=function(e){var t=n.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},p=function(e){var t=m(e.components);return n.createElement(o.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=m(a),c=r,h=u["".concat(o,".").concat(c)]||u[c]||d[c]||i;return a?n.createElement(h,l(l({ref:t},p),{},{components:a})):n.createElement(h,l({ref:t},p))}));function c(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,l=new Array(i);l[0]=u;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s.mdxType="string"==typeof e?e:r,l[1]=s;for(var m=2;m<i;m++)l[m]=a[m];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},4155:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>m});var n=a(7462),r=(a(7294),a(3905));const i={sidebar_position:5},l="Subscriptions Payments",s={unversionedId:"subscriptions/subscriptions-payments",id:"subscriptions/subscriptions-payments",title:"Subscriptions Payments",description:"When the Agreement between Merchant and MobilePay User is established, use the POST /api/providers//paymentrequests endpoint to en-queue Subscription Payments. This service accepts a JSON array of individual Subscription Payments to be processed asynchronously. You can batch payment requests into payloads of maximum of 2000 payments. We allow merchants to bundle multiple payment requests into a single HTTP request.",source:"@site/docs/subscriptions/subscriptions-payments.md",sourceDirName:"subscriptions",slug:"/subscriptions/subscriptions-payments",permalink:"/docs/subscriptions/subscriptions-payments",draft:!1,tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"docsSidebar",previous:{title:"Agreements",permalink:"/docs/subscriptions/agreement"},next:{title:"One-off Payments",permalink:"/docs/subscriptions/one-off-payments"}},o={},m=[{value:"Update existing Payment Request",id:"update-existing-payment-request",level:2},{value:"How do Subscription Payments work",id:"how-do-subscription-payments-work",level:2},{value:"Request parameters",id:"request-parameters",level:3},{value:"Frequency of Payment Requests",id:"frequency-of-payment-requests",level:2},{value:"Example of Frequency",id:"example-of-frequency",level:3},{value:"Payment screens",id:"payment-screens",level:2},{value:"Callbacks",id:"callbacks",level:2},{value:"Payment States",id:"payment-states",level:3},{value:"Payment Validation",id:"payment-validation",level:3},{value:"Failed Payments",id:"failed-payments",level:3},{value:"Payment state diagram",id:"payment-state-diagram",level:3},{value:"Other callback properties",id:"other-callback-properties",level:3},{value:"How to reconcile Subscriptions Payments",id:"how-to-reconcile-subscriptions-payments",level:2},{value:"User notifications",id:"user-notifications",level:2},{value:"Suspended",id:"suspended",level:2}],p={toc:m};function d(e){let{components:t,...i}=e;return(0,r.kt)("wrapper",(0,n.Z)({},p,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"subscriptions-payments"},"Subscriptions Payments"),(0,r.kt)("p",null,"When the ",(0,r.kt)("strong",{parentName:"p"},"Agreement")," between ",(0,r.kt)("strong",{parentName:"p"},"Merchant")," and MobilePay ",(0,r.kt)("strong",{parentName:"p"},"User")," is established, use the ",(0,r.kt)("inlineCode",{parentName:"p"},"POST /api/providers/{providerId}/paymentrequests")," endpoint to en-queue ",(0,r.kt)("strong",{parentName:"p"},"Subscription Payments"),". This service accepts a JSON array of individual ",(0,r.kt)("strong",{parentName:"p"},"Subscription Payments")," to be processed asynchronously. You can batch payment requests into payloads of maximum of 2000 payments. We allow merchants to bundle multiple payment requests into a single HTTP request.\nNotice that the ",(0,r.kt)("strong",{parentName:"p"},"Subscription Payments")," payload does not contain a currency code - this will be fetched from the ",(0,r.kt)("strong",{parentName:"p"},"Agreement")," using the provided ",(0,r.kt)("em",{parentName:"p"},"agreement_id"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="Create Payment Request"',title:'"Create',Payment:!0,'Request"':!0},'[\n    {\n        "agreement_id": "fda31b3c-794e-4148-ac00-77b957a7d47f",\n        "amount": "10.99",\n        "due_date": "2017-03-09",\n        "external_id": "PMT000023",\n        "description": "Monthly payment",\n        "grace_period_days": 3\n    }\n]\n')),(0,r.kt)("h2",{id:"update-existing-payment-request"},"Update existing Payment Request"),(0,r.kt)("p",null,"Once created, Recurring Payment Request can be updated (until it expires or is executed), Use the ",(0,r.kt)("inlineCode",{parentName:"p"},"PATCH /api/providers/{providerId}/agreements/{agreementId}/paymentrequests/{paymentId}")," endpoint to decrease the requested amount to be paid. It is possible to decrease the amount. However, it is not possible to increase it. We only validate based on the original amount set, we don't track the history. If you have sent a payment request with a too-high amount by mistake, you then can delete that payment request, and send another payment request with the correct amount.  "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'[\n    {\n        "value": "10.01",\n        "path": "/amount",\n        "op": "replace"\n    }\n]\n')),(0,r.kt)("h2",{id:"how-do-subscription-payments-work"},"How do Subscription Payments work"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Billing Cycle"),": You can send your payments to us max ",(0,r.kt)("em",{parentName:"li"},"126 days")," prior due date and min ",(0,r.kt)("em",{parentName:"li"},"1 day")," prior due date. When creating new subscription payments, the Merchant is responsible for configuring the billing cycle, so it matches their and customers needs. We support both fixed dates (for example, the 1st of the next month) and variable dates."),(0,r.kt)("li",{parentName:"ul"},"It is flexible to change when an existing subscription payment is billed next time. The customer just needs to have at least 1 day to evaluate the payment. The customer can evaluate the payment by opening the MobilePay app. In the activity list the customer is presented with the Pending payment."),(0,r.kt)("li",{parentName:"ul"},"For example: if you send the payment 1st of June before midnight, the earliest DueDate can be the 3rd of June."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Amount")," :  The Merchant decides the amount on each Payment Request. For example: electricity will vary to a certain extent, depending on how much electricity the customer is using, which is why an electric bill will fluctuate each month. You simply specify the amount each time you send a Payment Request. This is useful in cases where you want to charge your customers a granular amount based on their consumption of your service during the billing cycle, instead of explicitly setting a fixed amount. For example, Window Wash Company can use metered billing to offer a service where they wash their customer\u2019s windows as needed and charge at the end of the month for the total number of washes."),(0,r.kt)("li",{parentName:"ul"},"We recommend that you send the payments before 00:00:00 so that you are sure that they will be included in our payment processing."),(0,r.kt)("li",{parentName:"ul"},"The MobilePay user will be able to see Payments in the app from 8 days to 1 day before the due date depending on when you sent the payment."),(0,r.kt)("li",{parentName:"ul"},"If a payment changes status e.g. declined by users, a callback on the specific payment will be made to ",(0,r.kt)("inlineCode",{parentName:"li"},"/payment_status_callback_url")),(0,r.kt)("li",{parentName:"ul"},"On the due date we process the payments starting from 02:00 local time. If some payments weren't successfully completed, we will then try again at 06:00 local time and a couple of more time per day. Read more about hiccups in ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/MobilePayDev/MobilePayDev.github.io/edit/main/docs/subscriptions/subscriptions-payments.md#failed-payments"},"Failed payments"),". Payment execution might take couple of hours depending on payment load. We aim to complete all payment execution till 06:00 local time. Most heavy days is first and last days of the month, if possible we recommend you to choose other due date for your payment execution."),(0,r.kt)("li",{parentName:"ul"},"When ",(0,r.kt)("inlineCode",{parentName:"li"},"grace_period_days")," field is not set or is set to ",(0,r.kt)("strong",{parentName:"li"},"1"),", we will keep retrying to complete the payment up until 23:59 of the same day. When ",(0,r.kt)("inlineCode",{parentName:"li"},"grace_period_days")," is set to more than ",(0,r.kt)("strong",{parentName:"li"},"1"),", we will be trying to complete the payment for the specified number of days."),(0,r.kt)("li",{parentName:"ul"},"User will get a notification of approx. at 08:30 that we cannot process the payment and that they can complete it manually (by swiping). Notification will be sent every day at the same time for the whole grace period if ",(0,r.kt)("inlineCode",{parentName:"li"},"grace_period_days")," is specified."),(0,r.kt)("li",{parentName:"ul"},"At 23:59 we will decline the transaction and revert back with a callback  "),(0,r.kt)("li",{parentName:"ul"},"Subscription payments are collected automatically, so there is no need for the customer to swipe."),(0,r.kt)("li",{parentName:"ul"},"Reserve and Capture are managed by MobilePay."),(0,r.kt)("li",{parentName:"ul"},"note: The user cannot cancel their connection with the Merchant through MobilePay. They can solely disconnect their payment method. The merchant will receive callbacks in real-time, in case the customer unsubscribes to automatic payment in the MobilePay app. By default, the cancellation takes effect immediately. Afterward, you should clarify with the customer, how upcoming payments should be handled.")),(0,r.kt)("p",null,"Agreement disable_notification_management push notification. Merchants can set if their customers should be able to manage push notifications for an agreement or not. If the merchant chooses so, then the push notification is not displayed when signing a new agreement and when browsing agreement information."),(0,r.kt)("h3",{id:"request-parameters"},"Request parameters"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Parameter"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Required"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"),(0,r.kt)("th",{parentName:"tr",align:null},"Valid values"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"agreement_id")),(0,r.kt)("td",{parentName:"tr",align:null},"guid"),(0,r.kt)("td",{parentName:"tr",align:null},"required"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"The Subscription ",(0,r.kt)("strong",{parentName:"em"},"Agreement")," identifier that maps a ",(0,r.kt)("strong",{parentName:"em"},"Merchant")," to a MobilePay ",(0,r.kt)("strong",{parentName:"em"},"User"),".")),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"amount")),(0,r.kt)("td",{parentName:"tr",align:null},"number(0.00)"),(0,r.kt)("td",{parentName:"tr",align:null},"required"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"The requested amount to be paid.")),(0,r.kt)("td",{parentName:"tr",align:null},"Min 0.00, Max (FI) 2000.00 or Max (DK) 300000.00, decimals separated with a dot.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"due_date")),(0,r.kt)("td",{parentName:"tr",align:null},"date"),(0,r.kt)("td",{parentName:"tr",align:null},"required"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"Payment due date. Must be at least 1 day in the future, otherwise the ",(0,r.kt)("strong",{parentName:"em"},"Subscription Payment")," will be declined.")),(0,r.kt)("td",{parentName:"tr",align:null},"ISO date format: yyyy-MM-dd")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"external_id")),(0,r.kt)("td",{parentName:"tr",align:null},"string(64)"),(0,r.kt)("td",{parentName:"tr",align:null},"required"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"The identifier of a specific payment in the external merchant's system. Maximum length is 64 characters The external_id is visible on the ",(0,r.kt)("strong",{parentName:"em"},"Subscription Payment")," screen.")),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"description")),(0,r.kt)("td",{parentName:"tr",align:null},"string(60)"),(0,r.kt)("td",{parentName:"tr",align:null},"required"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"Additional information of the ",(0,r.kt)("strong",{parentName:"em"},"Subscription Payment")," that is visible for the customer in the MobilePay app")),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"grace_period_days")),(0,r.kt)("td",{parentName:"tr",align:null},"int"),(0,r.kt)("td",{parentName:"tr",align:null},"optional"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"Number of days to keep retrying the payment if it was not successful.")),(0,r.kt)("td",{parentName:"tr",align:null},"1, 2, 3")))),(0,r.kt)("admonition",{title:"External ID Recommendations",type:"note"},(0,r.kt)("p",{parentName:"admonition"},'The recommendation for "external_id" is to use up to 30 symbols. "external_id" is provided by Merchant or Integrator when initiating payments and is used for correlating transactions between MobilePay and Merchant or Integrator system. We recommend that it is unique, as then it is easier for MobilePay to search in the logs. The payment "external_id" is usually the merchant\'s internal "order_id". A good starting point is to use UUID, in the format ',(0,r.kt)("inlineCode",{parentName:"p"},"123e4567-e89b-12d3-a456-426614174000"),'. UUIDs are not always the most human-friendly, so see the other tips too. For instant transfers "external_id" is used as the payment reference and will be truncated down to 30 symbols if it contains more. Truncated payment references will be visible in customers\' bank statements.'),(0,r.kt)("p",{parentName:"admonition"},"If you need to make multiple payment requests in case the customer didn't pay, you can add a suffix to the external_id to make it unique: If your internal external_id  is mp-shop-123-order123abc you can add -1 to get a unique MobilePay external_id mp-shop-123-order123abc-1 for the first attempt, mp-shop-123-order123abc-2 for the second, etc. This is useful if a customer doesn't pay for their subscription, and when you are sending another request.")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"POST /api/providers/{providerId}/paymentrequests")," service returns HTTP 202 - Accepted response if at least one payment is provided in the request payload."),(0,r.kt)("p",null,"The response body contains two lists:"),(0,r.kt)("p",null,"-",(0,r.kt)("strong",{parentName:"p"},"pending_payments")," - a map of the newly generated Subscription payment ID and the external ID, that was accepted for processing and now are in a ",(0,r.kt)("em",{parentName:"p"},"Pending")," state.\n-",(0,r.kt)("strong",{parentName:"p"},"rejected_payments")," - a list of rejected payments. This can only occur if any of the mandatory fields are missing or do not conform to the format rule. Business logic validations are done asynchronously in the back-end (for example, rejecting if payments on the same due_date have the same external_id)."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",202:!0,className:"language-json",metastring:'title="HTTP 202 Response body example"',title:'"HTTP',Response:!0,body:!0,'example"':!0},'{\n    "pending_payments": [{\n            "payment_id": "263cfe92-9f8e-4829-8b96-14a5e53c9041",\n            "external_id": "PMT000023"\n        }\n    ],\n    "rejected_payments": [{\n            "external_id": "PMT000023",\n            "error_description": "The Amount field is required."\n        }\n    ]\n}\n')),(0,r.kt)("h2",{id:"frequency-of-payment-requests"},"Frequency of Payment Requests"),(0,r.kt)("p",null," The merchant can send a payment max 126 days prior due date, and at least 1 day before the due date. Valid values are 1, 2, 4, 12, 26, 52, 365, 0. This means that the daily payment (365) is the most frequent. When you are requesting payment, you need to keep in mind that there cannot be more than one payment on the same due_date with the same external_id. The user can have a few pending payments on the same due date. E.g. User can have 3 pending payments on the same due_date but the external_id of those payments should be different."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"External Id")," Payments cannot be created with the same external_id on same due_date."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Multiple Recurring payments"),"  Multiple recurring payment requests can be created within the period ","[126 before Due Date >= Payment Request Date >= 1 before Due Date]",".")),(0,r.kt)("h3",{id:"example-of-frequency"},"Example of Frequency"),(0,r.kt)("p",null,"For example: if you have a customer where the frequency of an agreement is set to 4, that means  365 / 4 = 91.25 (approximately payment requests every 3rd month), if the agreement frequency is set to 52, then 365 / 52 (payment requests every week) and in case the frequency is set to 0 - payment can be requested in flexible recurrence."),(0,r.kt)("h2",{id:"payment-screens"},"Payment screens"),(0,r.kt)("p",null,(0,r.kt)("a",{target:"_blank",href:a(3678).Z},(0,r.kt)("img",{alt:"Agreement payments",src:a(7557).Z,width:"5690",height:"2235"}))),(0,r.kt)("h2",{id:"callbacks"},"Callbacks"),(0,r.kt)("p",null,"Once the payment status changes from ",(0,r.kt)("em",{parentName:"p"},"Pending")," to ",(0,r.kt)("em",{parentName:"p"},"Executed, Declined, Rejected")," or ",(0,r.kt)("em",{parentName:"p"},"Failed"),", a callback will be done to the callback address, which is configurable via ",(0,r.kt)("inlineCode",{parentName:"p"},"PATCH /api/providers/{providerId}")," with path value ",(0,r.kt)("inlineCode",{parentName:"p"},"/payment_status_callback_url"),". The ",(0,r.kt)("inlineCode",{parentName:"p"},"/payment_status_callback_url"),' should be HTTPS. If you try to configure it to HTTP, you will get a bad request with the following error message: "The hyperlink reference must use https scheme"'),(0,r.kt)("p",null,"We are sending callbacks in two ways:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"A batch that runs every 2 mins. It contains Subscription payments with status: Declined/Rejected/Failed/Executed/OneOff_Expired. So in theory, there is a possible delay of 2 mins."),(0,r.kt)("li",{parentName:"ol"},"Right after the user made an action. It contains OneOff_Reserved/OneOff_Rejected.")),(0,r.kt)("p",null,"Every two minutes we take up to 1000 events (notifications about payment state), group them by merchant, and make the calls. Therefore, as for merchant, you should get up to 1 call every two minutes."),(0,r.kt)("p",null,"We will post the integrator or merchant a callback, and expect a HTTP 2xx response. If not we will retry 8 times."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'[\n    {\n        "value": "https://example.com",\n        "path": "/payment_status_callback_url",\n        "op": "replace"\n    }\n]\n')),(0,r.kt)("h1",{id:"subscriptions-callbacks"},"Subscriptions Callbacks"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Status"),(0,r.kt)("th",{parentName:"tr",align:null},"Status code"),(0,r.kt)("th",{parentName:"tr",align:null},"Status text"),(0,r.kt)("th",{parentName:"tr",align:null},"Callback sending condition"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Cancelled"),(0,r.kt)("td",{parentName:"tr",align:null},"70003"),(0,r.kt)("td",{parentName:"tr",align:null},"Payment cancelled."),(0,r.kt)("td",{parentName:"tr",align:null},"Pending payment cancelled due to user cancelling an agreement")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Cancelled"),(0,r.kt)("td",{parentName:"tr",align:null},"70003"),(0,r.kt)("td",{parentName:"tr",align:null},"Payment cancelled."),(0,r.kt)("td",{parentName:"tr",align:null},"Pending payment cancelled due to merchant cancelling an agreement")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Cancelled"),(0,r.kt)("td",{parentName:"tr",align:null},"70003"),(0,r.kt)("td",{parentName:"tr",align:null},"Payment cancelled."),(0,r.kt)("td",{parentName:"tr",align:null},"Merchant's initiated cancellation of pending recurring payment")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Executed"),(0,r.kt)("td",{parentName:"tr",align:null},"0"),(0,r.kt)("td",{parentName:"tr",align:null},"null"),(0,r.kt)("td",{parentName:"tr",align:null},"Payment successfully executed on due date")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Failed"),(0,r.kt)("td",{parentName:"tr",align:null},"50000"),(0,r.kt)("td",{parentName:"tr",align:null},"Payment failed to execute during the due date"),(0,r.kt)("td",{parentName:"tr",align:null},"Payment failed to execute during the due date")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Declined"),(0,r.kt)("td",{parentName:"tr",align:null},"70001"),(0,r.kt)("td",{parentName:"tr",align:null},"Payment amount is 5 times higher than agreement amount."),(0,r.kt)("td",{parentName:"tr",align:null},"Payment batch request contains a payment which amount is 5 times higher than the agreement's amount. Applicable when agreement has an amount more than 0")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Declined"),(0,r.kt)("td",{parentName:"tr",align:null},"50003"),(0,r.kt)("td",{parentName:"tr",align:null},'Declined by system: Agreement is not in "Active" state.'),(0,r.kt)("td",{parentName:"tr",align:null},"Payment batch request contains a payment for non-active agreement")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Declined"),(0,r.kt)("td",{parentName:"tr",align:null},"50004"),(0,r.kt)("td",{parentName:"tr",align:null},"Declined by system: Found duplicates for the same DueDate and AgreementId/ExternalId."),(0,r.kt)("td",{parentName:"tr",align:null},"Payment batch request contains a duplicate payment with the same DueDate and AgreementId/ExternalId")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Declined"),(0,r.kt)("td",{parentName:"tr",align:null},"50006"),(0,r.kt)("td",{parentName:"tr",align:null},"Declined by system."),(0,r.kt)("td",{parentName:"tr",align:null},"Unspecified error when processing payment from payment batch request")))),(0,r.kt)("h3",{id:"payment-states"},"Payment States"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Payment states",src:a(4919).Z,width:"146",height:"375"})),(0,r.kt)("h3",{id:"payment-validation"},"Payment Validation"),(0,r.kt)("p",null,"There are validation rules, that are applied asynchronously to each individual payment after you send an API request. Therefore, even though you get a response with pending payments, they may not be valid.  When you make a payment request, we will validate the request body itself, but we won't apply business rules to individual payments. So it only validates if you have the required parameters with the correct types. So the response you get for the payment request does not say if the payment is pending, but if the payment creation is pending. Then the payments are processed in our system, and they will either be requested (valid) or declined (invalid).\nYou will receive a callback if certain business rules are not met and payment is declined. This will be sent to your payment status callback URL."),(0,r.kt)("h3",{id:"failed-payments"},"Failed Payments"),(0,r.kt)("p",null,"The process for failed payments the DueDate is as follows:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"06:00 First hiccup is run at 06:00 on the due date. Once done, a notification about completion is returned. Merchant is informed about successful payments and user about failed payment."),(0,r.kt)("li",{parentName:"ul"},"13:30 Second hiccup is run at 13:30 on the due date. Once done, a notification about completion is returned. Merchant is informed about successful payments and user about failed payment."),(0,r.kt)("li",{parentName:"ul"},"18:00 20:00 22:30 23:40 - hiccups keep running throughout the day. Once done, a notification about completion is returned. Merchant is informed about successful payments and user about failed payment.")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"The flow will be processed for the number of days that can be specified in ",(0,r.kt)("inlineCode",{parentName:"p"},"grace_period_days"),", otherwise the flow will be processed once. Merchants will be notified about failed payments on the last day of the grace period.")),(0,r.kt)("h3",{id:"payment-state-diagram"},"Payment state diagram"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Payment states",src:a(9197).Z,width:"2535",height:"3142"})),(0,r.kt)("h3",{id:"other-callback-properties"},"Other callback properties"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"),(0,r.kt)("th",{parentName:"tr",align:null},"Format"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"agreement_id")),(0,r.kt)("td",{parentName:"tr",align:null},"guid"),(0,r.kt)("td",{parentName:"tr",align:null},"Subscription agreement ID on the MobilePay side."),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"payment_id")),(0,r.kt)("td",{parentName:"tr",align:null},"guid"),(0,r.kt)("td",{parentName:"tr",align:null},"Subscription payment ID on the MobilePay side."),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"amount")),(0,r.kt)("td",{parentName:"tr",align:null},"number(0.00)"),(0,r.kt)("td",{parentName:"tr",align:null},"Amount withdrawn from the MobilePay user."),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"currency")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Amount currency (agreement's currency)"),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"payment_date")),(0,r.kt)("td",{parentName:"tr",align:null},"date"),(0,r.kt)("td",{parentName:"tr",align:null},"Date of the batch when the payment was executed."),(0,r.kt)("td",{parentName:"tr",align:null},"ISO 8601 UTC date: YYYY-MM-DD")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"external_id")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Payment ID on the merchant's side. Maximum length is 64 characters"),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"payment_type")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Indicates whether it is Regular subscription payment or one-off payment."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"Regular")," or ",(0,r.kt)("em",{parentName:"td"},"OneOff"))))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="Payment callback body example"',title:'"Payment',callback:!0,body:!0,'example"':!0},'[\n    {\n        "agreement_id" : "1b08e244-4aea-4988-99d6-1bd22c6a5b2c",\n        "payment_id" : "c710b883-6ed6-4506-9599-490ead89525a",\n        "amount" : "10.20",\n        "currency" : "DKK",\n        "payment_date" : "2016-09-29",\n        "status" : "Rejected",\n        "status_text" : "Rejected by user.",\n        "status_code" : 50001,\n        "external_id" : "SFPMT134560",\n        "payment_type" : "Regular"\n    }\n]\n')),(0,r.kt)("h2",{id:"how-to-reconcile-subscriptions-payments"},"How to reconcile Subscriptions Payments"),(0,r.kt)("p",null,"You can choose a reference or ID on the subscription payments that your merchant sends via MobilePay Subscriptions. It is possible to do reconciliation in several ways."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Callbacks: You get the status of the payment through the API callbacks. When the payment has the status ",(0,r.kt)("inlineCode",{parentName:"li"},"executed")," then the customer has paid, and MobilePay sends a callback to you. Callbacks for subscription payments are found ",(0,r.kt)("a",{parentName:"li",href:"https://mobilepaydev.github.io/MobilePay-Subscriptions/payments#callbacks"},"here"),". Callbacks for one-off payments are found ",(0,r.kt)("a",{parentName:"li",href:"https://mobilepaydev.github.io/MobilePay-Subscriptions/oneoffs#callbacks"},"here"),"."),(0,r.kt)("li",{parentName:"ul"},"Mapping ",(0,r.kt)("inlineCode",{parentName:"li"},"external_id")," The individual transactions will contain the same ",(0,r.kt)("inlineCode",{parentName:"li"},"external_id"),", that you have assigned, and that ",(0,r.kt)("inlineCode",{parentName:"li"},"external_id")," will be returned through the API.  ",(0,r.kt)("inlineCode",{parentName:"li"},"external_id")," is the identifier of a specific payment in the merchant and integrator system."),(0,r.kt)("li",{parentName:"ul"},"CSV file via MobilePay Portal: The Merchant logs in to our MobilePay portal on ",(0,r.kt)("a",{parentName:"li",href:"https://admin.mobilepay.dk/"},"MobilePay Portal"),"  where you can export the transactions in a CSV file. This method is quite manual, but it is an easy way for Merchants to see their payments."),(0,r.kt)("li",{parentName:"ul"},"Use the Transaction Reporting API which contains GET calls containing specific transaction and transfer information, specifically the parameter  ",(0,r.kt)("inlineCode",{parentName:"li"},"MerchantReference")," as it directly is mapped to ",(0,r.kt)("inlineCode",{parentName:"li"},"external_id"))),(0,r.kt)("p",null,"For example, if the merchant wants to use their FIK-Creditor-ID for transactions, then you simply choose the reference number, which can be the merchant FIK Creditor ID. There are no special requirements for the merchant FIK creditor-ID to be able to use it for MobilePay Subscriptions."),(0,r.kt)("h2",{id:"user-notifications"},"User notifications"),(0,r.kt)("p",null,"As a MobilePay app user, the user can be informed about payment issues, depending on how the user has configured their Push Notification settings.  Push Notifications window: 08:30 - 22:00 DK time. We send push notifications to customers' smartphones. When a payment requires additional steps, such as customer authentication or exchange of card, the customer will be notified via push notifications. Upon receiving the push notification, the customer is prompted to complete the required action."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Description"),(0,r.kt)("th",{parentName:"tr",align:null},"When"),(0,r.kt)("th",{parentName:"tr",align:null},"Text"),(0,r.kt)("th",{parentName:"tr",align:null},"Buttons"),(0,r.kt)("th",{parentName:"tr",align:null},"Depends on these Notification settings"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Expired card:")," Card is expired or about to expire before the due date."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"8 -1 days before the due date, 08:30")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"English:")," Card is expired or about to expire. To continue with ",(0,r.kt)("em",{parentName:"td"},"Merchant")," payment update your card information. ",(0,r.kt)("strong",{parentName:"td"},"Danish:")," For at betale til ",(0,r.kt)("em",{parentName:"td"},"Merchant")," skal du opdatere dine kortinformationer. ",(0,r.kt)("strong",{parentName:"td"},"Finnish:")," Maksaaksesi *Merchant' - ole hyv\xe4 ja p\xe4ivit\xe4 korttitietosi."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Text"),": Opdater ",(0,r.kt)("strong",{parentName:"td"},"Navigation"),": Agreement Payments"),(0,r.kt)("td",{parentName:"tr",align:null},"OS, App"),(0,r.kt)("td",{parentName:"tr",align:null},"Subscription Payments")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"General Reminder")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"One day before the due date at 08:30")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"English:")," Payment for merchant ",(0,r.kt)("em",{parentName:"td"},"Merchant")," of ",(0,r.kt)("em",{parentName:"td"},"Amount")," ",(0,r.kt)("em",{parentName:"td"},"Currency")," will be executed tomorrow. ",(0,r.kt)("strong",{parentName:"td"},"Danish:")," I morgen betales ",(0,r.kt)("em",{parentName:"td"},"Amount")," ",(0,r.kt)("em",{parentName:"td"},"Currency")," til ",(0,r.kt)("em",{parentName:"td"},"Merchant"),". ",(0,r.kt)("strong",{parentName:"td"},"Finnish:")," ",(0,r.kt)("em",{parentName:"td"},"Merchant"),": ",(0,r.kt)("em",{parentName:"td"},"Amount")," ",(0,r.kt)("em",{parentName:"td"},"Currency")," maksu er\xe4\xe4ntyy huomenna."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Text"),": Vis ",(0,r.kt)("strong",{parentName:"td"},"Navigation"),": Payment Overview"),(0,r.kt)("td",{parentName:"tr",align:null},"OS, App"),(0,r.kt)("td",{parentName:"tr",align:null},"Subscription Payments")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Daily limit exceeded, increase to NemID"),(0,r.kt)("td",{parentName:"tr",align:null},"When the customer has exceeded daily limit"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"English:")," You have exceeded the amount limit. ",(0,r.kt)("strong",{parentName:"td"},"Danish:")," Din daglige bel\xf8bsgr\xe6nse er n\xe5et - klik her for at forh\xf8je den. ",(0,r.kt)("strong",{parentName:"td"},"Finnish:")," Maksuraja ylittynyt - Klikkaa t\xe4st\xe4 korottaaksesi maksurajaa."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Text"),": Forts\xe6t ",(0,r.kt)("strong",{parentName:"td"},"Navigation"),": Agreement Payments"),(0,r.kt)("td",{parentName:"tr",align:null},"OS, App"),(0,r.kt)("td",{parentName:"tr",align:null},"Subscription Payments")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Attached payment card is expired, the customer should change the card"),(0,r.kt)("td",{parentName:"tr",align:null},"When the card is expired"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"English:")," We cannot complete your payment - your card has expired. ",(0,r.kt)("strong",{parentName:"td"},"Danish:")," Vi kan ikke gennemf\xf8re din betaling - dit betalingskort er udl\xf8bet. ",(0,r.kt)("strong",{parentName:"td"},"Finnish:")," Maksua ei voida suorittaa - Kortti on vanhentunut."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Text"),": Skift dit betalingskort ",(0,r.kt)("strong",{parentName:"td"},"Navigation"),": Agreement Payments"),(0,r.kt)("td",{parentName:"tr",align:null},"OS, App"),(0,r.kt)("td",{parentName:"tr",align:null},"Subscription Payments")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Payment in other hiccup state - user can approve manually."),(0,r.kt)("td",{parentName:"tr",align:null},"When payment is in a hiccup state. Other issues with the Payment card, blocked, insufficient funds"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"English:")," We can not complete your payment - click here to help us. ",(0,r.kt)("strong",{parentName:"td"},"Danish:")," Vi kan ikke gennemf\xf8re din betaling - klik her for at hj\xe6lpe os. ",(0,r.kt)("strong",{parentName:"td"},"Finnish:")," Maksua ei voida suorittaa - Klikkaa t\xe4st\xe4 auttaaksesi meit\xe4."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Text"),": Vis ",(0,r.kt)("strong",{parentName:"td"},"Navigation"),": Agreement payments"),(0,r.kt)("td",{parentName:"tr",align:null},"OS, App"),(0,r.kt)("td",{parentName:"tr",align:null},"Subscription Payments")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Payment failed"),(0,r.kt)("td",{parentName:"tr",align:null},"When payment is in hiccup state"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"English:")," Your payment for merchant ",(0,r.kt)("em",{parentName:"td"},"Merchant")," failed to be completed. ",(0,r.kt)("strong",{parentName:"td"},"Danish:")," Vi kunne ikke gennemf\xf8re din betaling til ",(0,r.kt)("em",{parentName:"td"},"Merchant"),". ",(0,r.kt)("strong",{parentName:"td"},"Finnish:")," Maksua ",(0,r.kt)("em",{parentName:"td"},"Merchant")," ei voida toteuttaa."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Text"),": Vis ",(0,r.kt)("strong",{parentName:"td"},"Navigation"),": Agreement payments"),(0,r.kt)("td",{parentName:"tr",align:null},"OS, App"),(0,r.kt)("td",{parentName:"tr",align:null},"Subscription Payments")))),(0,r.kt)("h2",{id:"suspended"},"Suspended"),(0,r.kt)("p",null,"It means that you can not withdraw the money from the customer's payment card, and then the payment gets suspended. There can be various reasons why it can be suspended. If the problem persists, and there are not sufficient funds on the customer's card, or/and if the card is expired or/and blocked, then the payment will fail. Suspended is a status internally for MobilePay to mark hiccuped payments, which is why it is not a part of the callback table above."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Suspended")," will occur as soon as we have attempted 1 time - and that attempt has failed. It's fine that the Merchant use 'suspended' themselves to, in some way, nudge the customers to 'do something.' But it is primarily MobilePay's task - which we handle through push notifications and SMS."),(0,r.kt)("p",null,"Solution: MobilePay sends the customer a push notification, if there was an error with the card, in order to catch errors. If there were insufficient funds on the customer's card, we also push the customer to execute the payment manually. The Merchant should contact the customer and have it cleared out with the customer."),(0,r.kt)("p",null,"We also send sms messages each day at 10:00 in Denmark and 11:00 in Finland for customers who have suspended payments (one sms for each payment)."))}d.isMDXComponent=!0},3678:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/files/subs-Agreement_payments_3_new-b625854b406d2dfc2006f01971590776.png"},7557:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/subs-Agreement_payments_3_new-b625854b406d2dfc2006f01971590776.png"},4919:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/subs-PaymentStates-fcd35b46cff0810c36d83f3bc433b4ee.png"},9197:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/subs-Recurring_payment_states2-c1d0d6960f151716b59125749331d071.png"}}]);